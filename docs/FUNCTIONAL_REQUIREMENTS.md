# Функциональные требования BaseGrammy

**Версия документа:** 1.0
**Дата:** 2026-01-16
**Цель:** Описание всего функционала приложения для составления тестового покрытия

---

## 1. ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ

### 1.1 Управление профилем
- **FR-1.1.1** Система должна сохранять имя пользователя
- **FR-1.1.2** Система должна загружать имя пользователя при запуске
- **FR-1.1.3** Данные профиля должны храниться в YAML формате (`grammarmate/profile.yaml`)
- **FR-1.1.4** Система должна использовать имя по умолчанию "GrammarMateUser" если профиль не создан

---

## 2. СИСТЕМА ХРАНЕНИЯ ДАННЫХ

### 2.1 Атомарная запись файлов
- **FR-2.1.1** Все файлы должны записываться атомарно (через временный файл)
- **FR-2.1.2** Временный файл должен создаваться с суффиксом `.tmp`
- **FR-2.1.3** После записи временный файл должен переименовываться в целевой
- **FR-2.1.4** При ошибке временный файл должен удаляться

### 2.2 YAML хранилище
- **FR-2.2.1** Система должна поддерживать версионирование схем (`schemaVersion`)
- **FR-2.2.2** Система должна мигрировать старый формат списков в новый формат с оберткой
- **FR-2.2.3** YAML файлы должны сохраняться в UTF-8 кодировке

### 2.3 Резервное копирование
- **FR-2.3.1** Система должна создавать автоматические бэкапы каждые 30 минут
- **FR-2.3.2** Бэкапы должны сохраняться в `Downloads/BaseGrammy/backup_YYYY-MM-DD_HH-MM-SS/`
- **FR-2.3.3** Бэкап должен включать: `mastery.yaml`, `progress.yaml`, `streak.yaml`, `profile.yaml`
- **FR-2.3.4** Система должна автоматически восстанавливать данные из бэкапа после переустановки

---

## 3. УПРАВЛЕНИЕ ЯЗЫКАМИ И УРОКАМИ

### 3.1 Языки
- **FR-3.1.1** Система должна поддерживать множественные языки обучения
- **FR-3.1.2** Каждый язык должен иметь уникальный ID и название
- **FR-3.1.3** Список языков должен храниться в `grammarmate/lessons/languages.yaml`

### 3.2 Импорт уроков

#### 3.2.1 Импорт из ZIP пакета
- **FR-3.2.1.1** Система должна импортировать уроки из ZIP архива с манифестом
- **FR-3.2.1.2** Манифест должен содержать: `packId`, `packVersion`, `language`, `lessons`
- **FR-3.2.1.3** Система должна обрабатывать дефолтные пакеты из assets
- **FR-3.2.1.4** Система должна автоматически обновлять дефолтные пакеты при изменении версии

#### 3.2.2 Импорт из CSV
- **FR-3.2.2.1** Система должна импортировать отдельные CSV файлы уроков
- **FR-3.2.2.2** CSV должен содержать заголовок (название урока) в первой строке
- **FR-3.2.2.3** Заголовок должен обрезаться до первого знака пунктуации (`:`, `-`, и т.д.)
- **FR-3.2.2.4** Система должна удалять UTF-8 BOM если присутствует

#### 3.2.3 Формат CSV карточек
- **FR-3.2.3.1** Разделитель полей: точка с запятой `;`
- **FR-3.2.3.2** Формат строки: `"Русский текст";"Правильный ответ 1+Правильный ответ 2"`
- **FR-3.2.3.3** Множественные правильные ответы разделяются знаком `+`
- **FR-3.2.3.4** Пустые строки и строки без разделителя должны игнорироваться

### 3.3 Удаление уроков
- **FR-3.3.1** Система должна поддерживать удаление отдельного урока
- **FR-3.3.2** Система должна поддерживать удаление всех уроков языка
- **FR-3.3.3** Система должна поддерживать удаление пакета уроков
- **FR-3.3.4** При удалении урока должны удаляться связанные файлы (CSV, vocab, stories)

### 3.4 Структура урока
- **FR-3.4.1** Урок содержит ID, язык, название и список карточек
- **FR-3.4.2** Карточка содержит ID, русский промпт и список правильных ответов
- **FR-3.4.3** Первые 150 карточек - основной пул (main pool) для достижения мастерства
- **FR-3.4.4** Карточки после 150 - резервный пул (reserve pool) для разнообразия

---

## 4. ПОДУРОКИ И ПЛАНИРОВАНИЕ ПОВТОРЕНИЙ

### 4.1 Типы подуроков
- **FR-4.1.1** Система должна поддерживать тип `NEW_ONLY` (только новые карточки)
- **FR-4.1.2** Система должна поддерживать тип `MIXED` (новые + повторение)

### 4.2 Планировщик подуроков (MixedReviewScheduler)
- **FR-4.2.1** Размер подурока: 6-12 карточек (по умолчанию 10)
- **FR-4.2.2** Первый урок должен содержать только NEW_ONLY подуроки
- **FR-4.2.3** MIXED подуроки должны включать карточки из предыдущих уроков
- **FR-4.2.4** MIXED подуроки должны содержать не более 3 разных тем (уроков)
- **FR-4.2.5** Интервалы повторений: [1, 2, 4, 7, 10, 14, 20, 28, 42, 56] дней
- **FR-4.2.6** Размер "разминки" (warmup): первые 1-2 MIXED подурока с большим объемом повторений

### 4.3 Показ подуроков
- **FR-4.3.1** Система должна отображать прогресс подуроков в виде карточек
- **FR-4.3.2** Каждая карточка подурока должна показывать:
  - Индекс подурока
  - Тип (NEW_ONLY/MIXED)
  - Количество карточек
  - Состояние (пройден/не пройден)

---

## 5. РЕЖИМЫ ТРЕНИРОВКИ

### 5.1 Основные режимы (TrainingMode)
- **FR-5.1.1** `LESSON` - тренировка одного выбранного урока
- **FR-5.1.2** `ALL_SEQUENTIAL` - все уроки последовательно
- **FR-5.1.3** `ALL_MIXED` - все уроки вперемешку (максимум 300 карточек)
- **FR-5.1.4** Режим `ALL_MIXED` должен брать не более 300 карточек из всего набора
- **FR-5.1.5** Если карточек <= 300, система должна показать все доступные карточки
- **FR-5.1.6** Если карточек > 300, система должна случайным образом выбрать 300 карточек

### 5.2 Состояния сессии (SessionState)
- **FR-5.2.1** `ACTIVE` - активная тренировка
- **FR-5.2.2** `PAUSED` - пауза
- **FR-5.2.3** `AFTER_CHECK` - после проверки ответа
- **FR-5.2.4** `HINT_SHOWN` - показана подсказка

### 5.3 Режимы ввода (InputMode)
- **FR-5.3.1** `VOICE` - голосовой ввод через Android Speech Recognition
- **FR-5.3.2** `KEYBOARD` - ввод с клавиатуры
- **FR-5.3.3** `WORD_BANK` - выбор слов из банка слов
- **FR-5.3.4** **ВАЖНО:** Word Bank НЕ должен учитываться для роста мастерства!

---

## 6. ПРОВЕРКА ОТВЕТОВ И НОРМАЛИЗАЦИЯ

### 6.1 Нормализация текста (Normalizer)
- **FR-6.1.1** Удаление лишних пробелов (несколько пробелов → один)
- **FR-6.1.2** Приведение к нижнему регистру
- **FR-6.1.3** Удаление знаков пунктуации (`.`, `,`, `?`, `!`, `:`, `;`, `"`, скобки)
- **FR-6.1.4** Сохранение дефисов `-`
- **FR-6.1.5** Замена времени вида `HH:MM` на `HH` (например, `3:00` → `3`)
- **FR-6.1.6** Удаление начальных и конечных пробелов

### 6.2 Проверка ответа
- **FR-6.2.1** Ответ считается правильным, если нормализованный ввод совпадает с любым из `acceptedAnswers`
- **FR-6.2.2** Система должна показывать правильный ответ при ошибке
- **FR-6.2.3** Система должна подсчитывать количество правильных и неправильных ответов

---

## 7. ПРОГРЕСС ТРЕНИРОВКИ

### 7.1 Сохранение прогресса (ProgressStore)
- **FR-7.1.1** Текущий язык обучения (`languageId`)
- **FR-7.1.2** Режим тренировки (`TrainingMode`)
- **FR-7.1.3** ID текущего урока (`lessonId`)
- **FR-7.1.4** Индекс текущей карточки (`currentIndex`)
- **FR-7.1.5** Статистика правильных/неправильных ответов
- **FR-7.1.6** Время активной работы (`activeTimeMs`)
- **FR-7.1.7** Состояние сессии (`SessionState`)
- **FR-7.1.8** Награды за боссов (`bossLessonRewards`, `bossMegaReward`)
- **FR-7.1.9** Метрики голосового ввода (`voiceActiveMs`, `voiceWordCount`)
- **FR-7.1.10** Прогресс Elite-режима (`eliteStepIndex`, `eliteBestSpeeds`)

### 7.2 Чтение прогресса
- **FR-7.2.1** Система должна загружать прогресс при запуске приложения
- **FR-7.2.2** При отсутствии файла прогресса должны использоваться значения по умолчанию

### 7.3 Автосохранение
- **FR-7.3.1** Прогресс должен сохраняться автоматически после каждого изменения
- **FR-7.3.2** Прогресс должен сохраняться в `grammarmate/progress.yaml`

---

## 8. СИСТЕМА МАСТЕРСТВА (ЦВЕТЫ)

### 8.1 Состояния цветка (FlowerState)
- **FR-8.1.1** `LOCKED` - урок заблокирован
- **FR-8.1.2** `SEED` - семя (урок не начат, 0-33% мастерства)
- **FR-8.1.3** `SPROUT` - росток (33-66% мастерства)
- **FR-8.1.4** `BLOOM` - цветение (66-100% мастерства)
- **FR-8.1.5** `WILTING` - увядание (забывание, здоровье 50-100%)
- **FR-8.1.6** `WILTED` - увял (здоровье < 50%)
- **FR-8.1.7** `GONE` - исчез (> 90 дней без повторения)

### 8.2 Метрики мастерства (LessonMasteryState)
- **FR-8.2.1** `uniqueCardShows` - уникальные показы карточек (для мастерства)
- **FR-8.2.2** `totalCardShows` - всего показов (для статистики)
- **FR-8.2.3** `lastShowDateMs` - дата последнего показа
- **FR-8.2.4** `intervalStepIndex` - индекс в лестнице интервалов
- **FR-8.2.5** `completedAtMs` - время завершения урока
- **FR-8.2.6** `shownCardIds` - множество ID показанных карточек

### 8.3 Расчет состояния цветка (FlowerCalculator)
- **FR-8.3.1** Процент мастерства = `uniqueCardShows / 150 * 100%`
- **FR-8.3.2** Порог мастерства: 150 уникальных показов = 100% мастерства
- **FR-8.3.3** Здоровье цветка рассчитывается по кривой забывания
- **FR-8.3.4** Масштаб цветка = `masteryPercent * healthPercent` (минимум 50%)
- **FR-8.3.5** Если дней с последнего показа > 90 → состояние GONE

### 8.4 Запись показов карточек
- **FR-8.4.1** Система должна записывать показ карточки только для VOICE и KEYBOARD режимов
- **FR-8.4.2** Система НЕ должна записывать показы для WORD_BANK режима
- **FR-8.4.3** Система должна увеличивать `uniqueCardShows` только при первом показе карточки
- **FR-8.4.4** Система должна увеличивать `totalCardShows` при каждом показе
- **FR-8.4.5** Система должна обновлять `lastShowDateMs` при каждом показе
- **FR-8.4.6** Система должна добавлять ID карточки в `shownCardIds`

### 8.5 Хранение мастерства (MasteryStore)
- **FR-8.5.1** Данные должны храниться в `grammarmate/mastery.yaml`
- **FR-8.5.2** Система должна использовать кеш в памяти для быстрого доступа
- **FR-8.5.3** Система должна поддерживать чтение списка всех состояний мастерства
- **FR-8.5.4** Система должна поддерживать чтение состояния для конкретного урока

---

## 9. КРИВАЯ ЗАБЫВАНИЯ (SPACED REPETITION)

### 9.1 Алгоритм Эббингауза
- **FR-9.1.1** Формула: `R = e^(-t/S)` где R - вероятность вспоминания, t - время, S - стабильность
- **FR-9.1.2** Базовая стабильность: `S0 = 0.9` дней
- **FR-9.1.3** Множитель стабильности: `2.2` (увеличение после каждого успешного повторения)
- **FR-9.1.4** Стабильность растет экспоненциально: `S = S0 * 2.2^step`

### 9.2 Лестница интервалов
- **FR-9.2.1** Интервалы: [1, 2, 4, 7, 10, 14, 20, 28, 42, 56] дней
- **FR-9.2.2** Система должна определять ожидаемый интервал по `intervalStepIndex`
- **FR-9.2.3** Система должна продвигаться по лестнице при своевременном повторении
- **FR-9.2.4** Система должна оставлять шаг без изменений при просрочке

### 9.3 Расчет здоровья цветка
- **FR-9.3.1** Если повторение в пределах интервала → здоровье 100%
- **FR-9.3.2** При просрочке → экспоненциальное затухание от 100% до 50%
- **FR-9.3.3** Формула здоровья: `health = 0.5 + 0.5 * e^(-overdueDays/S)`
- **FR-9.3.4** Минимальное здоровье: 50% (порог увядания)
- **FR-9.3.5** Если дней > 90 → здоровье 0% (исчезновение)

---

## 10. BOSS РЕЖИМЫ

### 10.1 Типы боссов (BossType)
- **FR-10.1.1** `LESSON` - все карточки текущего урока
- **FR-10.1.2** `MEGA` - все карточки всех пройденных уроков
- **FR-10.1.3** `ELITE` - 7 этапов с увеличением скорости и случайной выборкой

### 10.2 Награды (BossReward)
- **FR-10.2.1** `BRONZE` - >50% правильных ответов
- **FR-10.2.2** `SILVER` - >75% правильных ответов
- **FR-10.2.3** `GOLD` - 100% правильных ответов

### 10.3 LESSON Boss
- **FR-10.3.1** Использует все карточки текущего урока
- **FR-10.3.2** Награда сохраняется в `bossLessonRewards[lessonId]`

### 10.4 MEGA Boss
- **FR-10.4.1** Использует все карточки всех пройденных уроков
- **FR-10.4.2** Награда сохраняется в `bossMegaReward`

### 10.5 ELITE Boss
- **FR-10.5.1** 7 этапов тренировки
- **FR-10.5.2** Каждый этап увеличивает скорость показа карточек
- **FR-10.5.3** Случайная выборка карточек из всех уроков
- **FR-10.5.4** Сохраняется лучшая скорость для каждого этапа в `eliteBestSpeeds`
- **FR-10.5.5** Прогресс текущего этапа сохраняется в `eliteStepIndex`

---

## 11. VOCAB SPRINT

### 11.1 Словарь (Vocab)
- **FR-11.1.1** Словарь содержит пары: английское слово → перевод
- **FR-11.1.2** Формат CSV: `"native_text";"target_text";"hard_flag"`
- **FR-11.1.3** Флаг `hard` помечает сложные слова для повторения

### 11.2 Vocab Sprint режим
- **FR-11.2.1** Ограничение количества слов (по умолчанию 20)
- **FR-11.2.2** До 3 попыток на каждое слово
- **FR-11.2.3** Поддержка всех режимов ввода (VOICE, KEYBOARD, WORD_BANK)
- **FR-11.2.4** Показ статистики правильных/неправильных ответов

### 11.3 Парсинг vocab CSV
- **FR-11.3.1** Разделитель: точка с запятой `;`
- **FR-11.3.2** Формат: `native;target` или `native;target;hard`
- **FR-11.3.3** Пустые строки игнорируются

---

## 12. STORY QUIZ

### 12.1 Структура истории
- **FR-12.1.1** ID истории (`storyId`)
- **FR-12.1.2** ID связанного урока (`lessonId`)
- **FR-12.1.3** Фаза (`phase`): CHECK_IN (до урока) или CHECK_OUT (после урока)
- **FR-12.1.4** Текст истории (`text`)
- **FR-12.1.5** Список вопросов (`questions`)

### 12.2 Структура вопроса
- **FR-12.2.1** ID вопроса (`qId`)
- **FR-12.2.2** Текст вопроса (`prompt`)
- **FR-12.2.3** Варианты ответов (`options`)
- **FR-12.2.4** Индекс правильного ответа (`correctIndex`)
- **FR-12.2.5** Объяснение правильного ответа (`explanation`, опционально)

### 12.3 Парсинг Story Quiz
- **FR-12.3.1** Формат: JSON
- **FR-12.3.2** Система должна валидировать все обязательные поля
- **FR-12.3.3** Система должна корректно парсить фазу (CHECK_IN/CHECK_OUT)

---

## 13. STREAK СИСТЕМА

### 13.1 Отслеживание серий (StreakData)
- **FR-13.1.1** Текущая серия дней (`currentStreak`)
- **FR-13.1.2** Рекордная серия дней (`longestStreak`)
- **FR-13.1.3** Дата последней активности (`lastActivityDateMs`)
- **FR-13.1.4** Общее количество дней занятий (`totalDays`)

### 13.2 Обновление streak
- **FR-13.2.1** Система должна увеличивать `currentStreak` при занятии в новый день
- **FR-13.2.2** Система должна сбрасывать `currentStreak` при пропуске дня
- **FR-13.2.3** Система должна обновлять `longestStreak` если `currentStreak` превышает его
- **FR-13.2.4** Система должна увеличивать `totalDays` при каждом новом дне занятий

### 13.3 Уведомления о достижениях
- **FR-13.3.1** Уведомление при достижении 1 дня
- **FR-13.3.2** Уведомление при достижении 3 дней
- **FR-13.3.3** Уведомление при достижении 7 дней
- **FR-13.3.4** Уведомление при достижении 14 дней
- **FR-13.3.5** Уведомление при достижении 30 дней
- **FR-13.3.6** Уведомление при достижении 100 дней

### 13.4 Хранение streak
- **FR-13.4.1** Данные должны храниться в `grammarmate/streak.yaml`
- **FR-13.4.2** Система должна загружать streak при запуске

---

## 14. НАСТРОЙКИ ПРИЛОЖЕНИЯ

### 14.1 AppConfigStore
- **FR-14.1.1** Размер подурока (`subLessonSize`): 6-12 карточек
- **FR-14.1.2** Настройки голосового ввода
- **FR-14.1.3** Настройки отображения
- **FR-14.1.4** Хранение в `grammarmate/config.yaml`

---

## 15. ДОПОЛНИТЕЛЬНЫЙ ФУНКЦИОНАЛ

### 15.1 Манифест пакета уроков
- **FR-15.1.1** Формат: JSON
- **FR-15.1.2** Обязательные поля: `schemaVersion`, `packId`, `packVersion`, `language`, `lessons`
- **FR-15.1.3** Каждый урок содержит: `lessonId`, `order`, `title`, `file`

### 15.2 Версионирование
- **FR-15.2.1** Все YAML файлы содержат `schemaVersion`
- **FR-15.2.2** Система должна поддерживать миграцию между версиями схем

### 15.3 Инкрементальные обновления
- **FR-15.3.1** При обновлении пакета старые данные не удаляются
- **FR-15.3.2** Новые уроки добавляются к существующим
- **FR-15.3.3** Обновленные уроки заменяют старые версии

---

## ПРИОРИТЕТЫ ТЕСТИРОВАНИЯ

### Критический функционал (P0)
- Сохранение и загрузка прогресса
- Запись показов карточек в mastery
- Расчет состояния цветков
- Кривая забывания
- Проверка ответов (нормализация)

### Важный функционал (P1)
- Импорт/экспорт уроков
- Планировщик подуроков
- Boss режимы
- Streak система

### Желательный функционал (P2)
- Vocab Sprint
- Story Quiz
- Бэкапы и восстановление

---

**Итого функциональных требований:** ~140

Этот документ является основой для составления тест-плана и должен покрывать весь функционал приложения для защиты от регрессий.
